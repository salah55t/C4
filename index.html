<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-pending { background-color: #4b5563; color: #f9fafb; }
        .status-open { background-color: #2563eb; color: #f9fafb; }
        .status-target_hit { background-color: #16a34a; color: #f9fafb; }
        .status-stop_loss_hit { background-color: #dc2626; color: #f9fafb; }
        .status-manual_close { background-color: #f97316; color: #f9fafb; }
        .profit { color: #22c55e; }
        .loss { color: #ef4444; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #fca5a5;
            background-color: #450a0a;
            border: 1px solid #991b1b;
            padding: 1rem;
            text-align: center;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-700">
            <h1 class="text-2xl md:text-3xl font-bold text-white">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø¨ÙˆØª Ø§Ù„ØªØ¯Ø§ÙˆÙ„</h1>
            <div id="stats-container" class="flex items-center gap-4 text-sm md:text-base">
                <!-- Stats will be loaded here -->
            </div>
        </header>

        <main class="space-y-8">
            <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙˆØµÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
            <div>
                <h2 class="text-xl font-semibold mb-3 text-blue-400">â³ ØªÙˆØµÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h2>
                <div id="pending-signals-wrapper" class="bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-700 text-xs text-gray-300 uppercase">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th scope="col" class="px-4 py-3">Ø³Ø¹Ø± Ø§Ù„ØªÙˆÙ„ÙŠØ¯</th>
                                    <th scope="col" class="px-4 py-3 text-red-400">Ø³Ø¹Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø§Ù„Ø¯Ø®ÙˆÙ„)</th>
                                    <th scope="col" class="px-4 py-3 text-green-400">Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø£ØµÙ„ÙŠ</th>
                                    <th scope="col" class="px-4 py-3">ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody id="pending-signals-body">
                                <!-- Data will be loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© -->
            <div>
                <h2 class="text-xl font-semibold mb-3 text-green-400">ğŸš€ ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø©</h2>
                <div id="open-signals-wrapper" class="bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-700 text-xs text-gray-300 uppercase">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th scope="col" class="px-4 py-3">Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</th>
                                    <th scope="col" class="px-4 py-3">Ø±Ø¨Ø­/Ø®Ø³Ø§Ø±Ø©</th>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ù‡Ø¯Ù 1 / Ø§Ù„Ù‡Ø¯Ù 2</th>
                                    <th scope="col" class="px-4 py-3">ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©</th>
                                    <th scope="col" class="px-4 py-3">Ø¥Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody id="open-signals-body">
                                <!-- Data will be loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª -->
            <div>
                <h2 class="text-xl font-semibold mb-3 text-gray-400">ğŸ“š Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª</h2>
                <div id="closed-signals-wrapper" class="bg-gray-800 shadow-lg rounded-lg overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-700 text-xs text-gray-300 uppercase">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ø¹Ù…Ù„Ø©</th>
                                    <th scope="col" class="px-4 py-3">Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                    <th scope="col" class="px-4 py-3">Ø³Ø¹Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th scope="col" class="px-4 py-3">Ø§Ù„Ø±Ø¨Ø­ %</th>
                                    <th scope="col" class="px-4 py-3">ÙˆÙ‚Øª Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</th>
                                </tr>
                            </thead>
                            <tbody id="closed-signals-body">
                               <!-- Data will be loaded by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
             <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
            <div>
                <h2 class="text-xl font-semibold mb-3 text-yellow-400">ğŸ”” Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</h2>
                <div id="notifications-wrapper" class="bg-gray-800 shadow-lg rounded-lg p-4 space-y-2 table-container">
                     <!-- Notifications will be loaded here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE_URL = window.location.origin;

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="flex justify-center items-center p-6"><div class="loader"></div></div>`;
        }

        function showErrorMessage(containerId, message) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function formatPrice(price) {
            if (price === null || typeof price === 'undefined') return '---';
            return parseFloat(price).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 });
        }

        function formatDate(dateString) {
            if (!dateString) return '---';
            try {
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return new Date(dateString).toLocaleString('ar-EG', options);
            } catch(e) {
                return dateString;
            }
        }

        async function fetchStats() {
            const containerId = 'stats-container';
            showLoading(containerId);
            try {
                const response = await fetch(`${API_BASE_URL}/api/stats`);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const stats = await response.json();
                
                document.getElementById(containerId).innerHTML = `
                    <div class="text-center">
                        <div class="font-bold text-lg text-white">${stats.total_closed_trades || 0}</div>
                        <div class="text-xs text-gray-400">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙ‚Ø§Øª</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-lg text-green-400">${stats.wins || 0}</div>
                        <div class="text-xs text-gray-400">ØµÙÙ‚Ø§Øª Ø±Ø§Ø¨Ø­Ø©</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-lg text-red-400">${stats.losses || 0}</div>
                        <div class="text-xs text-gray-400">ØµÙÙ‚Ø§Øª Ø®Ø§Ø³Ø±Ø©</div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-lg text-white">${(stats.win_rate || 0).toFixed(2)}%</div>
                        <div class="text-xs text-gray-400">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching stats:', error);
                showErrorMessage(containerId, 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª');
            }
        }

        async function fetchSignals() {
            const pendingWrapper = document.getElementById('pending-signals-wrapper');
            const openWrapper = document.getElementById('open-signals-wrapper');
            const closedWrapper = document.getElementById('closed-signals-wrapper');
            showLoading('pending-signals-body');
            showLoading('open-signals-body');
            showLoading('closed-signals-body');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/signals`);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const signals = await response.json();
                if (signals.error) throw new Error(signals.error);

                const pendingBody = document.getElementById('pending-signals-body');
                const openBody = document.getElementById('open-signals-body');
                const closedBody = document.getElementById('closed-signals-body');
                
                pendingBody.innerHTML = '';
                openBody.innerHTML = '';
                closedBody.innerHTML = '';

                let pendingCount = 0, openCount = 0, closedCount = 0;

                signals.forEach(s => {
                    if (s.status === 'pending') {
                        pendingCount++;
                        const triggerPrice = s.stop_loss;
                        pendingBody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-gray-900">
                                <td class="px-4 py-3 font-medium">${s.symbol}</td>
                                <td class="px-4 py-3">${formatPrice(s.generation_price)}</td>
                                <td class="px-4 py-3 font-bold text-red-400">${formatPrice(triggerPrice)}</td>
                                <td class="px-4 py-3 text-green-400">${formatPrice(s.target_price)}</td>
                                <td class="px-4 py-3 text-gray-400">${formatDate(s.created_at)}</td>
                            </tr>`;
                    } else if (s.status === 'open') {
                        openCount++;
                        const pnl = s.current_price && s.entry_price ? ((s.current_price / s.entry_price) - 1) * 100 : 0;
                        const pnlClass = pnl >= 0 ? 'profit' : 'loss';
                        const target1 = s.signal_details?.target_1 || 'N/A';
                        openBody.innerHTML += `
                            <tr class="border-b border-gray-700 hover:bg-gray-900">
                                <td class="px-4 py-3 font-medium">${s.symbol}</td>
                                <td class="px-4 py-3">${formatPrice(s.entry_price)}</td>
                                <td class="px-4 py-3">${formatPrice(s.current_price)}</td>
                                <td class="px-4 py-3 font-bold ${pnlClass}">${pnl.toFixed(2)}%</td>
                                <td class="px-4 py-3">${formatPrice(target1)} / ${formatPrice(s.target_price)}</td>
                                <td class="px-4 py-3">${formatPrice(s.stop_loss)}</td>
                                <td class="px-4 py-3">
                                    <button onclick="manualClose(${s.id})" class="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Ø¥ØºÙ„Ø§Ù‚</button>
                                </td>
                            </tr>`;
                    } else {
                        closedCount++;
                        const profitClass = s.profit_percentage >= 0 ? 'profit' : 'loss';
                        const statusClass = `status-${s.status}`;
                        const statusText = { 'target_hit': 'ØªØ­Ù‚Ù‚ Ø§Ù„Ù‡Ø¯Ù', 'stop_loss_hit': 'ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©', 'manual_close': 'Ø¥ØºÙ„Ø§Ù‚ ÙŠØ¯ÙˆÙŠ' }[s.status] || s.status;
                        closedBody.innerHTML += `
                             <tr class="border-b border-gray-700 hover:bg-gray-900">
                                <td class="px-4 py-3 font-medium">${s.symbol}</td>
                                <td class="px-4 py-3">${formatPrice(s.entry_price)}</td>
                                <td class="px-4 py-3">${formatPrice(s.closing_price)}</td>
                                <td class="px-4 py-3"><span class="px-2 py-1 text-xs rounded-full ${statusClass}">${statusText}</span></td>
                                <td class="px-4 py-3 font-bold ${profitClass}">${(s.profit_percentage || 0).toFixed(2)}%</td>
                                <td class="px-4 py-3 text-gray-400">${formatDate(s.closed_at)}</td>
                            </tr>`;
                    }
                });
                
                if (pendingCount === 0) pendingBody.innerHTML = `<tr><td colspan="5" class="text-center p-6 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
                if (openCount === 0) openBody.innerHTML = `<tr><td colspan="7" class="text-center p-6 text-gray-400">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</td></tr>`;
                if (closedCount === 0) closedBody.innerHTML = `<tr><td colspan="6" class="text-center p-6 text-gray-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù„ØµÙÙ‚Ø§Øª Ø¨Ø¹Ø¯.</td></tr>`;

            } catch (error) {
                console.error('Error fetching signals:', error);
                showErrorMessage('pending-signals-body', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.');
                showErrorMessage('open-signals-body', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©.');
                showErrorMessage('closed-signals-body', 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„ØµÙÙ‚Ø§Øª.');
            }
        }
        
        async function fetchNotifications() {
            const containerId = 'notifications-wrapper';
            showLoading(containerId);
             try {
                const response = await fetch(`${API_BASE_URL}/api/notifications`);
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                const notifications = await response.json();
                
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                if(!notifications || notifications.length === 0){
                    container.innerHTML = `<p class="text-center text-gray-400 py-6">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>`;
                    return;
                }
                
                notifications.forEach(n => {
                    const typeClass = { 'NEW_PENDING_SIGNAL': 'text-blue-400', 'TRADE_ACTIVATED': 'text-green-400', 'CLOSE_SIGNAL': 'text-yellow-400', 'SYSTEM': 'text-gray-400', 'ERROR': 'text-red-500'}[n.type] || 'text-gray-300';
                    container.innerHTML += `
                        <div class="flex items-start gap-3 text-sm p-2 border-b border-gray-700 last:border-0">
                            <span class="font-semibold ${typeClass}">[${formatDate(n.timestamp)}]</span>
                            <p class="flex-1">${n.message}</p>
                        </div>`;
                });

            } catch (error) {
                 console.error('Error fetching notifications:', error);
                 showErrorMessage(containerId, 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª');
            }
        }

        async function manualClose(signalId) {
            // Confirmation removed to avoid browser blocking issues.
            try {
                const response = await fetch(`${API_BASE_URL}/api/close/${signalId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                if (!response.ok) {
                    alert(`Ø®Ø·Ø£: ${result.error || 'ÙØ´Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©'}`);
                } else {
                    // Temporarily show a success message. For a real app, a toast notification is better.
                    alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø© #${signalId}.`);
                    fetchSignals(); // Refresh the list
                }
            } catch (error) {
                console.error('Error closing signal:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙÙ‚Ø©.');
            }
        }

        function fetchAllData() {
            fetchStats();
            fetchSignals();
            fetchNotifications();
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchAllData();
            setInterval(fetchAllData, 15000); // Refresh every 15 seconds
        });
    </script>
</body>
</html>
